<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>CodeDrop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- QR code (client-side) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial; background:#f6f7fb; margin:0; display:flex; justify-content:center}
    .wrap{width:min(900px,92vw); padding:28px}
    .brand{display:flex; align-items:center; gap:10px; margin-bottom:16px}
    .logo{width:24px; height:24px; background:#ff3b57; border-radius:6px}
    .card{background:#fff; border-radius:14px; padding:22px; box-shadow:0 8px 24px rgba(0,0,0,.06); margin:16px 0}
    .title{font-weight:700; font-size:20px; margin:0 0 12px}
    .sendBox{display:flex; align-items:center; justify-content:center; height:180px; border:2px dashed #ff3b57; border-radius:12px; cursor:pointer}
    .plus{font-size:72px; color:#ff3b57; line-height:1}
    .recvRow{display:flex; gap:10px}
    input.key{flex:1; padding:14px 16px; font-size:18px; border:1px solid #ddd; border-radius:10px}
    button{padding:12px 16px; border-radius:10px; border:1px solid #ddd; background:#fafafa; cursor:pointer}
    .muted{color:#777; font-size:13px}
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center}
    .dialog{background:#fff; border-radius:14px; padding:22px; width:min(520px,92vw)}
    .digits{display:flex; gap:10px; justify-content:center; margin:12px 0 8px}
    .digits span{width:40px; height:52px; border-radius:9px; background:#f2f3f7; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:700}
    .center{text-align:center}
    canvas{display:block; margin:10px auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="brand">
      <div class="logo"></div><div style="font-weight:700">CodeDrop</div>
    </div>

    <!-- Send -->
    <div class="card">
      <div class="title">Send</div>
      <label class="sendBox" id="sendBox">
        <div class="plus">+</div>
        <input id="fileInput" type="file" multiple hidden>
      </label>
      <div class="muted">คลิกปุ่ม + เพื่อเลือกไฟล์แล้วแชร์รหัสให้ผู้รับ</div>
    </div>

    <!-- Receive -->
    <div class="card">
      <div class="title">Receive</div>
      <div class="recvRow">
        <input class="key" id="key" placeholder="Input key (6 digits)" inputmode="numeric" maxlength="6">
        <button id="btnDownload">⬇️</button>
      </div>
      <div class="muted">หรือสแกน QR จากหน้า Waiting ของผู้ส่ง</div>
    </div>

    <!-- Waiting modal -->
    <div class="modal" id="modal">
      <div class="dialog">
        <div class="title">Waiting...</div>
        <div class="center muted">Enter the 6-digit key on the receiving device<br>
          Expires in <span id="ttl" style="color:#ff3b57;font-weight:700">10:00</span>
        </div>
        <div class="digits" id="digits"></div>
        <canvas id="qrcanvas" width="180" height="180" aria-label="QR"></canvas>
        <div class="center muted" id="dlUrl"></div>
        <div class="center" style="margin-top:10px"><button id="closeModal">Close</button></div>
      </div>
    </div>
  </div>

<script>
// ---------- helper: countdown mm:ss ----------
function startCountdown(sec, el, onEnd){
  function tick(){
    const m = Math.floor(sec/60).toString().padStart(2,'0');
    const s = (sec%60).toString().padStart(2,'0');
    el.textContent = `${m}:${s}`;
    if (sec-- <= 0) return onEnd && onEnd();
    timer = setTimeout(tick, 1000);
  }
  let timer; tick(); return () => clearTimeout(timer);
}

// ---------- UI refs ----------
const sendBox = document.getElementById('sendBox');    // กล่อง +
const fileInput = document.getElementById('fileInput');// อินพุตไฟล์
const modal = document.getElementById('modal');        // โมดอลรอรับ
const digitsBox = document.getElementById('digits');   // แสดงเลข 6 หลัก
const ttlEl = document.getElementById('ttl');          // นับถอยหลัง
const qrCanvas = document.getElementById('qrcanvas');  // QR
const dlUrlEl = document.getElementById('dlUrl');      // โชว์ลิงก์
const btnClose = document.getElementById('closeModal');// ปิด
const keyInput = document.getElementById('key');       // ช่องคีย์
const btnDl = document.getElementById('btnDownload');  // ปุ่มดาวน์โหลด

// คลิกกล่อง + เพื่อเปิดเลือกไฟล์
sendBox.addEventListener('click', ()=> fileInput.click());

// เมื่อเลือกไฟล์ → อัปโหลดไฟล์แรก (จะเลือกหลายไฟล์ก็ทำได้ แต่ตัวอย่างโหลดทีละคีย์)
fileInput.addEventListener('change', async ()=>{
  const file = fileInput.files && fileInput.files[0];
  if(!file) return;

  const fd = new FormData();      // สร้างฟอร์ม
  fd.append('file', file);        // แนบไฟล์

  const res = await fetch('/upload', { method:'POST', body: fd }); // อัปโหลดไปเซิร์ฟเวอร์
  if(!res.ok){ alert('Upload failed'); return; }
  const { code, expiresIn } = await res.json(); // ได้คีย์ + เวลาหมดอายุ (วินาที)

  // แสดงโมดอล Waiting + นับถอยหลัง
  showWaiting(code, expiresIn);
});

// แสดงหน้ารอ พร้อมเลข 6 หลักและ QR (ลิงก์ดาวน์โหลด)
function showWaiting(code, expiresIn){
  // วางเลข 6 หลักให้เป็นกล่อง ๆ
  digitsBox.innerHTML = '';
  code.split('').forEach(d => {
    const span = document.createElement('span');
    span.textContent = d;
    digitsBox.appendChild(span);
  });

  // สร้าง URL สำหรับผู้รับ
  const url = `${location.origin}/d/${code}`;
  dlUrlEl.textContent = url;

  // สร้าง QR (ลิงก์ดาวน์โหลด)
  QRCode.toCanvas(qrCanvas, url, { margin:1 }, (err)=>{ if(err) console.error(err); });

  // เปิดโมดอล + เริ่มนับถอยหลัง
  modal.style.display = 'flex';
  if(window._stopTimer) window._stopTimer();
  window._stopTimer = startCountdown(expiresIn, ttlEl, ()=>{
    ttlEl.textContent = '00:00';
  });
}

// ปุ่มปิด Waiting
btnClose.addEventListener('click', ()=> modal.style.display='none');

// ฝั่งผู้รับ: กดดาวน์โหลดด้วยคีย์
btnDl.addEventListener('click', ()=>{
  const code = (keyInput.value||'').trim();
  if(!/^\d{6}$/.test(code)){ alert('กรุณากรอกเลข 6 หลัก'); return; }
  // เปิดลิงก์ดาวน์โหลด → เบราว์เซอร์จะโหลดไฟล์ทันที
  location.href = `/d/${code}`;
});
</script>
</body>
</html>
